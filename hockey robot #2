#include <PRIZM.h>
#include <TELEOP.h>

PRIZM spback;
PS4 controller;
EXPANSION motorExp;

int servoDelayMs = 680;
int reverse = false;
int timeBeforeFlipMs = 330;
int speed = 100;

void setup() {
  spback.PrizmBegin();
  controller.setDeadZone (LEFT,10);    
  controller.setDeadZone(RIGHT,10);
  motorExp.resetEncoder(1, 2);
  spback.setServoSpeed(1, 100);
  spback.setServoPosition(1, 18);
}

void loop() {
  controller.getPS4();                                 

  //main update loop
  if(controller.Connected && controller.inRange){
    reverseDrive();
    move();
    intake();
    timedFlip();
    letBallThrough();
    if (controller.Button(UP)){    
      manualFlip(-1);
    }else if (controller.Button(DOWN)){    
      manualFlip(1);
    }else{
      flip();
    }
  }
  else{                                         
    spback.setMotorPowers(0,0);
    motorExp.setMotorPowers(1,0,0);
  }
}

void reverseDrive(){
  if (controller.Button(SQUARE)){
    reverse ^= true;
    delay(300);
  }
}

void move(){
  speed = map(controller.Touchpad(TOUCHX), 0, 1920, 0, 1);
  if (reverse){
    spback.setMotorPowers(floor(controller.Motor(LY)*speed) *-1, floor(controller.Motor(RY)*speed));
  }else{
    spback.setMotorPowers(floor(controller.Motor(RY))*speed, floor(controller.Motor(LY)*speed) *-1);
  }
}

void intake(){
  motorExp.setMotorPower(1, 1, controller.Motor(L2T));
}

void timedFlip(){
  if (controller.Button(R1)){
    
    //ball servo
    spback.setServoPosition(1, 40);
    delay(servoDelayMs);
    spback.setServoPosition(1, 18);
    
    delay(timeBeforeFlipMs);

    //flipper
    motorExp.setMotorPower(1, 2, -100);
    delay(500);
    motorExp.setMotorPower(1, 2, 0);
    delay(300);
  }
}

void letBallThrough(){
  if (controller.Button(CIRCLE)){
    spback.setServoPosition(1, 40);
    delay(servoDelayMs);
    spback.setServoPosition(1, 18);
    delay(200);
  }
}

void flip(){ // gear ratio is   40 : 32
  if (controller.Button(R2)){
    motorExp.setMotorPower(1, 2, -100);
    delay(500);
    motorExp.setMotorPower(1, 2, 0);
    delay(300);
    // motorExp.setMotorTarget(1, 2, 360, 1540);
    // delay(3000);
    // motorExp.resetEncoder(1, 2);
  }
}

void manualFlip(int direction){
  motorExp.setMotorPower(1, 2, controller.Motor(R2T)*direction*0.5);
}
